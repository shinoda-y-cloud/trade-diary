<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒˆãƒ¬ãƒ¼ãƒ‰æ—¥è¨˜ï¼ˆProç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111a33; --text:#e9eefc; --muted:#9fb0dd;
      --border:rgba(255,255,255,0.12);
      --accent:#67d3ff; --good:#49e3a2; --bad:#ff6b6b; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,sans-serif;
      background:radial-gradient(1200px 700px at 20% -10%, #17306b 0%, transparent 55%),
                 radial-gradient(900px 600px at 110% 20%, #2b145b 0%, transparent 55%),
                 var(--bg);
      color:var(--text); padding-bottom:40px;
    }
    
    .container { max-width:1000px; margin:0 auto; padding:0 16px; }
    header { padding:20px 0 10px; display:flex; justify-content:space-between; align-items:end; flex-wrap:wrap; gap:10px; }
    h1 { font-size:18px; margin:0; }
    .header-btns { display:flex; gap:8px; flex-wrap:wrap; }

    /* Card Design */
    .card {
      background:rgba(17,26,51,0.6);
      border:1px solid var(--border);
      box-shadow:0 12px 40px rgba(0,0,0,0.3);
      border-radius:12px; margin-bottom:16px;
      overflow:hidden;
    }
    .card-hd {
      background:rgba(255,255,255,0.03);
      padding:10px 14px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color:var(--muted);
    }
    .card-bd { padding:14px; }

    /* Grid Layouts */
    .form-grid {
      display:grid; grid-template-columns: 1fr; gap:12px 12px;
    }
    @media (min-width: 600px) { .form-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 900px) { .form-grid { grid-template-columns: repeat(4, 1fr); } }

    /* Form Elements */
    label { display:block; font-size:11px; color:var(--muted); margin-bottom:4px; }
    select, input, textarea {
      width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border);
      color:var(--text); border-radius:6px; padding:8px; outline:none; font-size:13px;
    }
    select:focus, input:focus { border-color:var(--accent); background:rgba(0,0,0,0.5); }
    textarea { min-height:38px; height:38px; resize:vertical; }

    /* Layout Helpers */
    .col-full { grid-column: 1 / -1; }
    .col-half { grid-column: span 1; }
    @media (min-width: 600px) { .col-half { grid-column: span 2; } }

    /* Buttons */
    button {
      border:none; cursor:pointer; padding:6px 12px; border-radius:6px;
      font-size:12px; font-weight:700; transition:0.2s; white-space:nowrap;
    }
    .btn-primary { background:var(--accent); color:#0b1020; }
    .btn-primary:hover { opacity:0.9; }
    .btn-sec { background:transparent; border:1px solid var(--border); color:var(--muted); }
    .btn-sec:hover { border-color:var(--text); color:var(--text); }
    .btn-danger { background:rgba(255,107,107,0.2); color:var(--bad); border:1px solid var(--bad); }
    .btn-danger:hover { background:var(--bad); color:#fff; }
    .btn-icon { padding:6px 10px; }

    /* Chips */
    .chip-group { display:flex; flex-wrap:wrap; gap:6px; }
    .chip {
      display:flex; align-items:center; gap:4px; padding:4px 8px;
      border-radius:99px; background:rgba(255,255,255,0.05); border:1px solid var(--border);
      font-size:11px; cursor:pointer; user-select:none;
    }
    .chip:hover { background:rgba(255,255,255,0.1); }
    .chip input { width:auto; margin:0; }
    .chip-del { margin-left:6px; color:var(--bad); cursor:pointer; font-weight:bold; }

    /* Dashboard & Table */
    .kpi-row { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px; }
    .kpi-box { background:rgba(0,0,0,0.2); border-radius:8px; padding:8px; text-align:center; border:1px solid var(--border); }
    .kpi-label { font-size:10px; color:var(--muted); }
    .kpi-val { font-size:16px; font-weight:bold; color:var(--text); }
    .v-good { color:var(--good); } .v-bad { color:var(--bad); }

    .tbl-wrap { overflow-x:auto; }
    .tbl { width:100%; border-collapse:collapse; font-size:12px; white-space:nowrap; }
    .tbl th { text-align:left; color:var(--muted); padding:6px; border-bottom:1px solid var(--border); }
    .tbl td { padding:6px; border-bottom:1px solid rgba(255,255,255,0.05); }
    .tag { padding:2px 6px; border-radius:4px; font-size:10px; border:1px solid var(--border); }
    .tag.win { border-color:var(--good); color:var(--good); }
    .tag.lose { border-color:var(--bad); color:var(--bad); }

    .flex-center { display:flex; align-items:center; gap:8px; }
    .text-right { text-align:right; }
    .mini-text { font-size:10px; color:var(--muted); margin-top:4px; }

    /* Modals */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:99; padding:10px;}
    .modal-box { width:min(600px, 100%); background:#0f1730; border:1px solid var(--border); border-radius:12px; padding:20px; box-shadow:0 20px 50px #000; max-height:90vh; overflow-y:auto;}
    
    /* Config Modal Specifics */
    .cfg-section { margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:12px; }
    .cfg-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .cfg-add-row { display:flex; gap:8px; margin-top:8px; }
  </style>
</head>

<body>

<div class="container">
  <header>
    <div>
      <h1>ãƒˆãƒ¬ãƒ¼ãƒ‰æ—¥è¨˜ (Pro)</h1>
      <div class="mini-text" id="ghLabel">GitHub: æœªè¨­å®š</div>
    </div>
    <div class="header-btns">
      <button class="btn-sec" id="btnConfig">âš™ï¸ é¸æŠè‚¢ã®ç·¨é›†</button>
      <button class="btn-sec" id="btnGitHub">GitHubè¨­å®š</button>
      <button class="btn-sec" id="btnBackup">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <button class="btn-sec" id="btnRestore">å¾©å…ƒ</button>
      <button class="btn-sec" id="btnRelock">ãƒ­ãƒƒã‚¯</button>
    </div>
  </header>

  <section class="card">
    <div class="card-hd">
      <span>ğŸ“ ä»Šæ—¥ã®è¨˜éŒ² (<span id="todayLabel">-</span>)</span>
      <div class="flex-center">
        <button class="btn-sec" id="btnLoadToday" style="padding:2px 8px; font-size:10px;">èª­è¾¼</button>
        <button class="btn-sec" id="btnResetForm" style="padding:2px 8px; font-size:10px;">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div class="card-bd form-grid">
      <div>
        <label>æ—¥ä»˜</label>
        <input type="date" id="date" />
      </div>
      <div>
        <label>ç›¸å ´ç’°å¢ƒ</label>
        <select id="marketType">
          <option value="ä¸æ˜">ä¸æ˜</option>
          <option value="ãƒˆãƒ¬ãƒ³ãƒ‰">ãƒˆãƒ¬ãƒ³ãƒ‰</option>
          <option value="ãƒ¬ãƒ³ã‚¸">ãƒ¬ãƒ³ã‚¸</option>
          <option value="è’ã„">è’ã„</option>
          <option value="è–„ã„">è–„ã„</option>
        </select>
      </div>
      <div>
        <label>çµæœ</label>
        <select id="result">
          <option value="æœªå…¥åŠ›">æœªå…¥åŠ›</option>
          <option value="å‹ã¡">å‹ã¡</option>
          <option value="è² ã‘">è² ã‘</option>
          <option value="ãƒˆãƒ³ãƒˆãƒ³">ãƒˆãƒ³ãƒˆãƒ³</option>
          <option value="ãƒãƒ¼ãƒˆãƒ¬">ãƒãƒ¼ãƒˆãƒ¬</option>
        </select>
      </div>
      <div>
        <label>æç›Š (å††)</label>
        <input type="number" id="pnl" placeholder="ä¾‹: -13070" />
      </div>

      <div>
        <label>ã‚¨ãƒ³ãƒˆãƒªãƒ¼å›æ•°</label>
        <input type="number" id="trades" placeholder="å›æ•° (ä¾‹: 5)" />
      </div>
      <div>
        <label>æ–¹å‘æ„Ÿ</label>
        <select id="bias">
          <option value="ä¸æ˜">ä¸æ˜</option>
          <option value="ãƒ­ãƒ³ã‚°">ãƒ­ãƒ³ã‚°</option>
          <option value="ã‚·ãƒ§ãƒ¼ãƒˆ">ã‚·ãƒ§ãƒ¼ãƒˆ</option>
          <option value="ä¸¡æ–¹ãƒ€ãƒ¡">ä¸¡æ–¹ãƒ€ãƒ¡</option>
        </select>
      </div>
      <div>
        <label>è² ã‘ä¸»å› </label>
        <select id="lossCause"></select>
      </div>
      <div>
        <label>å®ˆã‚ŒãŸãƒ«ãƒ¼ãƒ«</label>
        <select id="keptRule"></select>
      </div>

      <div>
        <label>è‡ªå·±è©•ä¾¡</label>
        <select id="grade">
          <option value="æœªå…¥åŠ›">æœªå…¥åŠ›</option>
          <option value="S">S (å®Œç’§)</option>
          <option value="A">A (è‰¯ã„)</option>
          <option value="B">B (æ™®é€š)</option>
          <option value="C">C (æ‚ªã„)</option>
        </select>
      </div>
      <div>
        <label>æ˜æ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
        <select id="nextAction"></select>
      </div>

      <div class="col-half">
        <label>ä¸»æˆ¦éŠ˜æŸ„ (é¸æŠ + è‡ªç”±å…¥åŠ›)</label>
        <div class="chip-group" id="coreTickers"></div>
        <input type="text" id="extraTickers" placeholder="ãã®ä»– (ä¾‹: 9101 å•†èˆ¹ä¸‰äº•)" style="margin-top:6px;" />
      </div>

      <div class="col-full">
        <label>ä¸€è¨€ãƒ¡ãƒ¢</label>
        <input type="text" id="memo" maxlength="100" placeholder="ä¾‹: æ–¹å‘æ„Ÿãªã—ã€‚-4000å††ã§æ’¤é€€ã€‚" />
      </div>
      
      <div class="col-full" style="display:flex; gap:10px; margin-top:4px;">
        <button class="btn-primary" id="btnSave" style="flex:1;">ä¿å­˜ (ãƒ­ãƒ¼ã‚«ãƒ«)</button>
        <button class="btn-sec" id="btnExportCsv">CSV</button>
        <button class="btn-danger" id="btnClearAll">å…¨å‰Šé™¤</button>
      </div>
      <div class="col-full mini-text" id="autoHint">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: OFF</div>
    </div>
  </section>

  <section class="card">
    <div class="card-hd">
      <span>ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (<span id="countLabel">0</span>ä»¶)</span>
    </div>
    <div class="card-bd">
      <div class="kpi-row">
        <div class="kpi-box">
          <div class="kpi-label">ä»Šæœˆæç›Š</div>
          <div class="kpi-val" id="kpiMonthPnl">0</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">å‹ç‡</div>
          <div class="kpi-val" id="kpiWinRate">-</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">ãƒãƒ¼ãƒˆãƒ¬ç‡</div>
          <div class="kpi-val" id="kpiNoTrade">-</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">æœ€å¤šæ•—å› </div>
          <div class="kpi-val" id="kpiTopCause" style="font-size:12px;">-</div>
        </div>
      </div>

      <div class="tbl-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th style="width:80px;">æ—¥ä»˜</th>
              <th style="width:50px;">çµæœ</th>
              <th style="width:70px; text-align:right;">æç›Š</th>
              <th style="padding-left:12px;">è¦ç´„</th>
              <th style="width:80px; text-align:right;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<div class="overlay" id="lockBg" style="display:flex;">
  <div class="modal-box" style="text-align:center;">
    <h3>ğŸ”’ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯</h3>
    <input type="password" id="lockPass" placeholder="ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin:16px 0; text-align:center; font-size:16px;" />
    <button class="btn-primary" id="btnUnlock" style="width:100%;">è§£é™¤</button>
    <div class="mini-text" style="color:var(--bad); display:none; margin-top:8px;" id="lockErr">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>
  </div>
</div>

<div class="overlay" id="configBg">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
      <h3 style="margin:0;">é¸æŠè‚¢ã®ç·¨é›†</h3>
      <button class="btn-sec" id="btnCloseConfig" style="padding:2px 8px;">é–‰ã˜ã‚‹</button>
    </div>
    
    <div id="cfgContainer">
      </div>
    <div class="mini-text">â€» å¤‰æ›´ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
  </div>
</div>

<div class="overlay" id="modalBg">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
      <h3 style="margin:0;">GitHubè¨­å®š</h3>
      <button class="btn-sec" id="btnCloseModal" style="padding:2px 8px;">é–‰ã˜ã‚‹</button>
    </div>
    <div class="mini-text" id="ghStatus" style="margin-bottom:12px;">çŠ¶æ…‹: æœªè¨­å®š</div>
    
    <div class="form-grid">
      <div><label>Owner</label><input id="ghOwner" placeholder="user" /></div>
      <div><label>Repo</label><input id="ghRepo" placeholder="repo" /></div>
      <div><label>Branch</label><input id="ghBranch" placeholder="main" /></div>
      <div><label>Path</label><input id="ghPath" placeholder="data/diary.json" /></div>
      <div class="col-full"><label>Token (PAT)</label><input id="ghToken" type="password" /></div>
      <div class="col-full">
        <label>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</label>
        <select id="autoMode">
          <option value="off">OFF</option>
          <option value="onsave">ä¿å­˜æ™‚ã«å®Ÿè¡Œ (æ¨å¥¨)</option>
          <option value="interval">å®šæœŸå®Ÿè¡Œ (15åˆ†)</option>
        </select>
        <input type="hidden" id="autoMinutes" value="15">
      </div>
      <div class="col-full" style="display:flex; gap:10px; margin-top:8px;">
        <button class="btn-primary" id="btnSaveGh" style="flex:1;">ä¿å­˜</button>
        <button class="btn-sec" id="btnTest">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-danger" id="btnClearGh">è§£é™¤</button>
      </div>
    </div>
  </div>
</div>

<script>
  // =========================
  // MASTER DATA & CONFIG
  // =========================
  const OPT_KEY = "tradeDiary_options";
  
  const DEFAULTS = {
    lossCause: ["é€†å¼µã‚Šç™–", "åœ°åˆã„æ‚ª", "ãƒ–ãƒ¬ã‚¤ã‚¯ãƒ€ãƒã‚·", "åˆ©ç¢ºãŒæ—©ã„", "æåˆ‡ã‚ŠãŒé…ã„", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãŒæ—©ã„", "ãƒ­ãƒƒãƒˆãŒé‡ã„", "é›†ä¸­ã§ããªã„"],
    keptRule: ["æåˆ‡ã‚Šã‚’å¾¹åº•", "ãƒ­ãƒƒãƒˆæŠ‘åˆ¶", "è¿·ã£ãŸã‚‰è¦‹é€ã‚Š", "1éŠ˜æŸ„é›†ä¸­", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼å¾…ã¦ãŸ", "å¾Œå ´ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã—ãªã„"],
    nextAction: ["åœ°åˆã„ã‚’è¦‹ã¦ç›®ç·šã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹", "å¯„ã‚Š15åˆ†ã¯è§¦ã‚‰ãªã„", "VWAPä»˜è¿‘ã¯è¦‹é€ã‚Š", "ãƒ–ãƒ¬ã‚¤ã‚¯ã¯2æœ¬ç¢ºå®šå¾Œ", "1æ—¥1éŠ˜æŸ„ã«çµã‚‹", "ãƒãƒ¼ãƒˆãƒ¬ã‚‚æ­£è§£ã¨ã™ã‚‹"],
    coreTickers: ["8031 ä¸‰äº•ç‰©ç”£", "9503 é–¢è¥¿é›»åŠ›", "5020 ENEOS", "3099 ä¸‰è¶Šä¼Šå‹¢ä¸¹", "7011 ä¸‰è±é‡å·¥", "6501 æ—¥ç«‹"]
  };

  let userOpts = JSON.parse(localStorage.getItem(OPT_KEY) || "null") || JSON.parse(JSON.stringify(DEFAULTS));

  function saveUserOpts(){
    localStorage.setItem(OPT_KEY, JSON.stringify(userOpts));
    renderSelects();
  }

  // Render Select Options
  function renderSelects(){
    const fill = (id, list) => {
      const el = document.getElementById(id);
      if(!el) return;
      el.innerHTML = '<option value="æœªå…¥åŠ›">æœªå…¥åŠ›</option>';
      list.forEach(v => {
        const op = document.createElement("option");
        op.value = v; op.textContent = v;
        el.appendChild(op);
      });
    };
    
    fill("lossCause", userOpts.lossCause);
    fill("keptRule", userOpts.keptRule);
    fill("nextAction", userOpts.nextAction);

    // Ticker Chips
    const tc = document.getElementById("coreTickers");
    tc.innerHTML = "";
    userOpts.coreTickers.forEach(t => {
      const lbl = document.createElement("label");
      lbl.className = "chip";
      lbl.innerHTML = `<input type="checkbox" value="${t}">${t.split(" ")[1]||t}`;
      tc.appendChild(lbl);
    });
  }

  // Config Modal Logic
  const cfgBg = document.getElementById("configBg");
  const cfgCont = document.getElementById("cfgContainer");

  function renderConfigUI(){
    cfgCont.innerHTML = "";
    const sections = [
      { key:"lossCause", title:"è² ã‘ä¸»å› " },
      { key:"keptRule", title:"å®ˆã‚ŒãŸãƒ«ãƒ¼ãƒ«" },
      { key:"nextAction", title:"æ˜æ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" },
      { key:"coreTickers", title:"ä¸»æˆ¦éŠ˜æŸ„ (ãƒãƒƒãƒ—)" }
    ];

    sections.forEach(sec => {
      const div = document.createElement("div");
      div.className = "cfg-section";
      
      const tit = document.createElement("div");
      tit.style.fontWeight = "bold"; tit.style.marginBottom = "6px";
      tit.textContent = sec.title;
      div.appendChild(tit);

      // Add Row
      const row = document.createElement("div");
      row.className = "cfg-add-row";
      const inp = document.createElement("input");
      inp.placeholder = "é …ç›®ã‚’è¿½åŠ ";
      const btn = document.createElement("button");
      btn.className = "btn-primary";
      btn.textContent = "è¿½åŠ ";
      btn.onclick = () => {
        const val = inp.value.trim();
        if(val && !userOpts[sec.key].includes(val)){
          userOpts[sec.key].push(val);
          saveUserOpts();
          renderConfigUI(); // re-render self
        }
      };
      row.appendChild(inp); row.appendChild(btn);
      div.appendChild(row);

      // List
      const list = document.createElement("div");
      list.className = "cfg-list";
      userOpts[sec.key].forEach(item => {
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.style.cursor = "default";
        chip.innerHTML = `${item} <span class="chip-del" onclick="removeOpt('${sec.key}', '${item}')">Ã—</span>`;
        list.appendChild(chip);
      });
      div.appendChild(list);
      cfgCont.appendChild(div);
    });
  }

  window.removeOpt = (key, val) => {
    if(confirm(`ã€Œ${val}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){
      userOpts[key] = userOpts[key].filter(x => x !== val);
      saveUserOpts();
      renderConfigUI();
    }
  };

  document.getElementById("btnConfig").onclick = () => {
    renderConfigUI();
    cfgBg.style.display = "flex";
  };
  document.getElementById("btnCloseConfig").onclick = () => {
    cfgBg.style.display = "none";
  };


  // =========================
  // CORE LOGIC (Preserved)
  // =========================
  const PASSCODE = "kyoto.3594"; 
  const UNLOCK_KEY = "tradeDiary_unlocked_v1";
  const KEY = "tradeDiary_v1";
  const GHKEY = "tradeDiary_github";

  const $ = (id) => document.getElementById(id);

  // Lock
  const lockBg=$("lockBg"), lockPass=$("lockPass"), lockErr=$("lockErr");
  function isUnlocked(){ return localStorage.getItem(UNLOCK_KEY) === "1"; }
  function showLock(){ lockBg.style.display="flex"; lockPass.value=""; lockErr.style.display="none"; setTimeout(()=>lockPass.focus(),50); }
  function hideLock(){ lockBg.style.display="none"; }
  function unlock(){
    if(lockPass.value.trim()===PASSCODE){ localStorage.setItem(UNLOCK_KEY,"1"); hideLock(); }
    else{ lockErr.style.display="block"; }
  }
  $("btnUnlock").onclick=unlock;
  $("btnRelock").onclick=()=>{ localStorage.removeItem(UNLOCK_KEY); showLock(); };
  lockPass.onkeydown=(e)=>{ if(e.key==="Enter") unlock(); };
  if(!isUnlocked()) showLock(); else hideLock();

  // Elements
  const els = {
    date:$("date"), marketType:$("marketType"), result:$("result"), pnl:$("pnl"),
    trades:$("trades"), bias:$("bias"), lossCause:$("lossCause"), keptRule:$("keptRule"),
    grade:$("grade"), nextAction:$("nextAction"), memo:$("memo"), extraTickers:$("extraTickers")
  };
  const ui = {
    todayLabel:$("todayLabel"), countLabel:$("countLabel"), rows:$("rows"),
    kpiMonthPnl:$("kpiMonthPnl"), kpiWinRate:$("kpiWinRate"), kpiNoTrade:$("kpiNoTrade"), kpiTopCause:$("kpiTopCause")
  };

  const todayISO=()=>{ const d=new Date(); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); };
  
  function loadAll(){ try{return JSON.parse(localStorage.getItem(KEY)||"[]");}catch{return[];} }
  function saveAll(d){ localStorage.setItem(KEY,JSON.stringify(d)); }
  function fmtYen(n){ if(!Number.isFinite(n))return"-"; return (n>0?"+":"")+n.toLocaleString(); }

  // Tickers Helper
  const getCore=()=>Array.from(document.querySelectorAll("#coreTickers input:checked")).map(e=>e.value);
  const setCore=(vals)=>{ const s=new Set(vals||[]); document.querySelectorAll("#coreTickers input").forEach(e=>e.checked=s.has(e.value)); };

  // Form <-> Entry
  function formToEntry(){
    return {
      date:els.date.value||todayISO(), marketType:els.marketType.value, result:els.result.value,
      pnl:els.pnl.value===""?null:Number(els.pnl.value),
      tickers:[...getCore(), ...(els.extraTickers.value||"").split(",").map(s=>s.trim()).filter(Boolean)],
      trades:els.trades.value, // Now free text/number
      bias:els.bias.value, lossCause:els.lossCause.value,
      keptRule:els.keptRule.value, grade:els.grade.value, nextAction:els.nextAction.value,
      memo:(els.memo.value||"").trim(), updatedAt:new Date().toISOString()
    };
  }
  function entryToForm(e){
    els.date.value=e.date||todayISO(); els.marketType.value=e.marketType||"ä¸æ˜"; els.result.value=e.result||"æœªå…¥åŠ›";
    els.pnl.value=Number.isFinite(e.pnl)?e.pnl:"";
    const ts=e.tickers||[];
    
    // Check if ticks exist in userOpts, if not, maybe add them? (Optional, kept simple here)
    setCore(ts); 
    els.extraTickers.value=ts.filter(t=> !userOpts.coreTickers.includes(t)).join(",");
    
    els.trades.value=e.trades||"";
    els.bias.value=e.bias||"ä¸æ˜"; els.lossCause.value=e.lossCause||"æœªå…¥åŠ›";
    els.keptRule.value=e.keptRule||"æœªå…¥åŠ›"; els.grade.value=e.grade||"æœªå…¥åŠ›"; els.nextAction.value=e.nextAction||"æœªå…¥åŠ›";
    els.memo.value=e.memo||"";
  }

  // Render Rows
  function render(){
    const all=loadAll();
    ui.countLabel.textContent=all.length; ui.todayLabel.textContent=els.date.value||todayISO();
    
    // KPI
    const ym=new Date().toISOString().slice(0,7);
    const m=all.filter(x=>(x.date||"").startsWith(ym));
    const pnl=m.reduce((a,x)=>a+(x.pnl||0),0);
    ui.kpiMonthPnl.textContent=fmtYen(pnl);
    ui.kpiMonthPnl.className="kpi-val "+(pnl>0?"v-good":(pnl<0?"v-bad":""));
    
    const w=m.filter(x=>x.result==="å‹ã¡").length, l=m.filter(x=>x.result==="è² ã‘").length;
    ui.kpiWinRate.textContent=(w+l)>0?Math.round(w/(w+l)*100)+"%":"-";
    const nt=m.filter(x=>x.result==="ãƒãƒ¼ãƒˆãƒ¬").length;
    ui.kpiNoTrade.textContent=m.length>0?Math.round(nt/m.length*100)+"%":"-";

    const counts={}; m.forEach(x=>{ if(x.lossCause&&x.lossCause!=="æœªå…¥åŠ›") counts[x.lossCause]=(counts[x.lossCause]||0)+1; });
    let top="-", max=0; for(let k in counts)if(counts[k]>max){max=counts[k];top=k;}
    ui.kpiTopCause.textContent=top;

    // Table
    ui.rows.innerHTML="";
    all.slice().reverse().forEach(e=>{
      const tr=document.createElement("tr");
      const tag=e.result==="å‹ã¡"?"win":(e.result==="è² ã‘"?"lose":"");
      const pnlC=e.pnl>0?"v-good":(e.pnl<0?"v-bad":"");
      tr.innerHTML=`
        <td>${e.date}</td>
        <td><span class="tag ${tag}">${e.result}</span></td>
        <td class="text-right ${pnlC}">${fmtYen(e.pnl)}</td>
        <td style="padding-left:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; max-width:200px;">
          ${e.tickers.join("/")} | ${e.lossCause} | ${e.memo}
        </td>
        <td class="text-right">
          <button class="btn-sec" style="padding:2px 6px;" onclick="loadEntry('${e.date}')">ç·¨é›†</button>
          <button class="btn-danger" style="padding:2px 6px;" onclick="delEntry('${e.date}')">Ã—</button>
        </td>
      `;
      ui.rows.appendChild(tr);
    });
    
    updateGhLabel();
  }

  window.loadEntry=(d)=>{ const f=loadAll().find(x=>x.date===d); if(f){ entryToForm(f); render(); window.scrollTo({top:0,behavior:"smooth"}); }};
  window.delEntry=(d)=>{ if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ const n=loadAll().filter(x=>x.date!==d); saveAll(n); render(); }};

  // Actions
  $("btnSave").onclick=()=>{
    const e=formToEntry();
    const all=loadAll(), idx=all.findIndex(x=>x.date===e.date);
    if(idx>=0)all[idx]=e; else all.push(e);
    all.sort((a,b)=>a.date.localeCompare(b.date));
    saveAll(all); render();
    const cfg=loadGH(); if(cfg&&(cfg.autoMode==="onsave")) backupGH();
    alert("ä¿å­˜ã—ã¾ã—ãŸ");
  };
  $("btnResetForm").onclick=()=>{ entryToForm({date:todayISO()}); render(); };
  $("btnLoadToday").onclick=()=>{ const f=loadAll().find(x=>x.date===(els.date.value||todayISO())); if(f) entryToForm(f); else alert("ãªã—"); render(); };
  $("btnClearAll").onclick=()=>{ if(confirm("å…¨å‰Šé™¤ï¼Ÿ")){ localStorage.removeItem(KEY); render(); }};
  
  $("btnExportCsv").onclick=()=>{
    const csv=["date,result,pnl,tickers,memo,updatedAt"];
    loadAll().forEach(e=>csv.push(`${e.date},${e.result},${e.pnl||""},"${e.tickers.join(" ")}","${e.memo}",${e.updatedAt}`));
    const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv.join("\n")],{type:"text/csv"}));
    a.download="diary.csv"; a.click();
  };

  // GitHub Logic
  const loadGH=()=>JSON.parse(localStorage.getItem(GHKEY)||"null");
  const saveGH=(c)=>localStorage.setItem(GHKEY,JSON.stringify(c));
  const isGHReady=(c)=>c&&c.token&&c.owner&&c.repo;
  const modal=$("modalBg");
  
  $("btnGitHub").onclick=()=>{
    modal.style.display="flex"; const c=loadGH()||{};
    $("ghOwner").value=c.owner||""; $("ghRepo").value=c.repo||""; $("ghToken").value=c.token||"";
    $("ghBranch").value=c.branch||"main"; $("ghPath").value=c.path||"data/diary.json";
    $("autoMode").value=c.autoMode||"off";
    updateGhStatus();
  };
  $("btnCloseModal").onclick=()=>{ modal.style.display="none"; };
  
  $("btnSaveGh").onclick=()=>{
    const c={owner:$("ghOwner").value, repo:$("ghRepo").value, branch:$("ghBranch").value, path:$("ghPath").value, token:$("ghToken").value, autoMode:$("autoMode").value};
    saveGH(c); updateGhStatus(); updateGhLabel(); alert("è¨­å®šä¿å­˜");
  };
  $("btnClearGh").onclick=()=>{ localStorage.removeItem(GHKEY); updateGhStatus(); updateGhLabel(); };

  function updateGhStatus(){
    const c=loadGH(); $("ghStatus").textContent=isGHReady(c)?"è¨­å®šæ¸ˆã¿":"æœªè¨­å®š";
    $("autoHint").textContent = "è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: " + (c&&c.autoMode!=="off" ? "ON" : "OFF");
  }
  function updateGhLabel(){
    const c=loadGH(); $("ghLabel").textContent="GitHub: "+(isGHReady(c)?`${c.owner}/${c.repo}`:"æœªè¨­å®š");
  }

  const headers=(c)=>({"Authorization":`token ${c.token}`, "Accept":"application/vnd.github+json"});
  async function ghGet(c){
    const res=await fetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${c.path}?ref=${c.branch}`,{headers:headers(c)});
    if(res.status===404)return{sha:null,data:[]};
    const j=await res.json();
    return {sha:j.sha, data:JSON.parse(decodeURIComponent(escape(atob(j.content))))};
  }
  async function ghPut(c,data,sha){
    const body={message:"update", content:btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))), branch:c.branch, sha};
    await fetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${c.path}`,{method:"PUT",headers:headers(c),body:JSON.stringify(body)});
  }
  function merge(loc,rem){
    const m=new Map(); [...loc,...rem].forEach(e=>{
      const old=m.get(e.date);
      if(!old || new Date(e.updatedAt)>new Date(old.updatedAt)) m.set(e.date,e);
    });
    return Array.from(m.values()).sort((a,b)=>a.date.localeCompare(b.date));
  }
  async function backupGH(){
    const c=loadGH(); if(!isGHReady(c))return;
    const r=await ghGet(c), l=loadAll();
    const merged=merge(l, r.data||[]);
    await ghPut(c,merged,r.sha); saveAll(merged); render();
  }
  async function restoreGH(){
    const c=loadGH(); if(!isGHReady(c))return;
    const r=await ghGet(c), l=loadAll();
    const merged=merge(l, r.data||[]);
    saveAll(merged); render();
  }

  $("btnBackup").onclick=async()=>{ try{await backupGH();alert("å®Œäº†");}catch(e){alert("å¤±æ•—:"+e);} };
  $("btnRestore").onclick=async()=>{ try{await restoreGH();alert("å®Œäº†");}catch(e){alert("å¤±æ•—:"+e);} };
  $("btnTest").onclick=async()=>{ try{await ghGet(loadGH());alert("æ¥ç¶šOK");}catch(e){alert("å¤±æ•—:"+e);} };

  // Initialize
  renderSelects();
  els.date.value=todayISO();
  render();
</script>
</body>
</html>
