<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒˆãƒ¬ãƒ¼ãƒ‰æ—¥è¨˜ (Ultimate v2)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111a33; --text:#e9eefc; --muted:#9fb0dd;
      --border:rgba(255,255,255,0.12);
      --accent:#67d3ff; --good:#49e3a2; --bad:#ff6b6b; --warn:#ffd166;
      --long:#4facfe; --short:#ff5858; --mix:#a18cd1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,sans-serif;
      background:radial-gradient(1200px 700px at 20% -10%, #17306b 0%, transparent 55%),
                 radial-gradient(900px 600px at 110% 20%, #2b145b 0%, transparent 55%),
                 var(--bg);
      color:var(--text); padding-bottom:80px;
    }

    .container { max-width:1000px; margin:0 auto; padding:0 16px; }
    header { padding:20px 0 10px; display:flex; justify-content:space-between; align-items:end; flex-wrap:wrap; gap:10px; }
    h1 { font-size:18px; margin:0; font-weight:800; letter-spacing:1px; }
    .header-btns { display:flex; gap:8px; flex-wrap:wrap; }

    .card {
      background:rgba(17,26,51,0.6);
      border:1px solid var(--border);
      box-shadow:0 12px 40px rgba(0,0,0,0.3);
      border-radius:8px; margin-bottom:16px;
      overflow:hidden;
    }
    .card-hd {
      background:rgba(255,255,255,0.03);
      padding:10px 14px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color:var(--muted);
    }
    .card-bd { padding:14px; }

    .form-grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 600px) { .form-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 900px) { .form-grid { grid-template-columns: repeat(4, 1fr); } }

    label { display:block; font-size:11px; color:var(--muted); margin-bottom:4px; }
    select, input, textarea {
      width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border);
      color:var(--text); border-radius:4px; padding:8px; outline:none; font-size:13px;
    }
    select:focus, input:focus { border-color:var(--accent); background:rgba(0,0,0,0.5); }
    textarea { min-height:38px; height:38px; resize:vertical; }

    .col-full { grid-column: 1 / -1; }
    .col-half { grid-column: span 1; }
    @media (min-width: 600px) { .col-half { grid-column: span 2; } }

    button {
      border:none; cursor:pointer; padding:6px 12px; border-radius:4px;
      font-size:12px; font-weight:700; transition:0.2s; white-space:nowrap;
    }
    .btn-primary { background:var(--accent); color:#0b1020; }
    .btn-primary:hover { opacity:0.9; }
    .btn-sec { background:transparent; border:1px solid var(--border); color:var(--muted); }
    .btn-sec:hover { border-color:var(--text); color:var(--text); }
    .btn-danger { background:rgba(255,107,107,0.15); color:var(--bad); border:1px solid rgba(255,107,107,0.3); }
    .btn-danger:hover { background:var(--bad); color:#fff; }

    .toggle-group { display:flex; background:rgba(0,0,0,0.3); border-radius:6px; padding:2px; border:1px solid var(--border); }
    .toggle-btn { flex:1; text-align:center; padding:6px 12px; font-size:12px; border-radius:4px; cursor:pointer; color:var(--muted); }
    .toggle-btn.active { background:var(--accent); color:#0b1020; font-weight:bold; }

    .chip-group { display:flex; flex-wrap:wrap; gap:8px; }
    .chip {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:4px;
      background:rgba(255,255,255,0.05);
      border:1px solid var(--border);
      font-size:12px; cursor:pointer; user-select:none;
      white-space:nowrap; transition: all 0.2s;
    }
    .chip:hover { background:rgba(255,255,255,0.1); border-color:var(--accent); }
    .chip input { margin:0; width:auto; }
    .chip-del { margin-left:6px; color:var(--bad); font-weight:bold; padding:0 4px; cursor:pointer; }
    .chip-del:hover { background:rgba(255,107,107,0.2); border-radius:4px; }

    .kpi-row { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:15px; }
    .kpi-box { background:rgba(0,0,0,0.2); border-radius:6px; padding:8px; text-align:center; border:1px solid var(--border); }
    .kpi-label { font-size:10px; color:var(--muted); }
    .kpi-val { font-size:16px; font-weight:bold; color:var(--text); }
    .v-good { color:var(--good); } .v-bad { color:var(--bad); }

    .timeline { display:flex; flex-direction:column; gap:16px; }
    .t-card {
      background:rgba(17,26,51,0.6); border:1px solid var(--border);
      border-radius:8px; padding:16px; position:relative; overflow:hidden;
    }
    .t-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; gap:10px; }
    .t-date-grp { display:flex; flex-direction:column; gap:4px; }
    .t-date { font-size:14px; font-weight:bold; color:var(--text); display:flex; align-items:center; gap:8px;}
    .t-actions { display:flex; gap:6px; }
    .t-pnl-row { display:flex; align-items:baseline; gap:12px; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.05); }
    .t-pnl { font-size:20px; font-weight:800; letter-spacing:0.5px; }
    .t-meta { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px; }
    .badge {
      font-size:10px; padding:3px 8px; border-radius:4px;
      border:1px solid var(--border); color:var(--muted); font-weight:600;
      display:inline-flex; align-items:center; gap:4px;
    }
    .badge.long { border-color:rgba(79,172,254,0.4); color:var(--long); background:rgba(79,172,254,0.1); }
    .badge.short { border-color:rgba(255,88,88,0.4); color:var(--short); background:rgba(255,88,88,0.1); }
    .badge.mix { border-color:rgba(161,140,209,0.4); color:var(--mix); background:rgba(161,140,209,0.1); }
    .badge.cnt-ok { border-color:rgba(73,227,162,0.4); color:var(--good); }
    .badge.cnt-warn { border-color:rgba(255,209,102,0.4); color:var(--warn); }
    .badge.cnt-bad { border-color:rgba(255,107,107,0.4); color:var(--bad); }
    .badge.rank-a { border-color:var(--good); color:#0b1020; background:var(--good); }
    .badge.rank-b { border-color:var(--muted); color:var(--text); }
    .badge.rank-c { border-color:var(--bad); color:var(--bad); }
    .badge.rank-s {
      border:1px solid #ffd700;
      background: linear-gradient(135deg, #ffd700 0%, #fdb931 50%, #ffd700 100%);
      color: #5c4d00;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
      text-shadow: 0 1px 0 rgba(255,255,255,0.4);
      animation: shine 3s infinite linear;
      font-weight:800; padding:3px 10px;
    }
    @keyframes shine {
      0% { background-position: 0% 50%; box-shadow: 0 0 5px rgba(255,215,0,0.3); }
      50% { background-position: 100% 50%; box-shadow: 0 0 15px rgba(255,215,0,0.7); }
      100% { background-position: 0% 50%; box-shadow: 0 0 5px rgba(255,215,0,0.3); }
    }
    .t-body {
      background:rgba(0,0,0,0.25); border-radius:6px; padding:12px;
      margin-bottom:12px; font-size:13px; line-height:1.6; color:#fff; white-space: pre-wrap;
    }
    .t-foot {
      display:grid; grid-template-columns: 1fr; gap:8px;
      font-size:11px; color:var(--muted);
    }
    @media (min-width: 600px) { .t-foot { grid-template-columns: 1fr 1fr 1fr; } }
    .t-item strong { display:block; color:var(--accent); font-size:10px; margin-bottom:2px; opacity:0.8; }

    .tbl-wrap { overflow-x:auto; }
    .tbl { width:100%; border-collapse:collapse; font-size:12px; white-space:nowrap; }
    .tbl th { text-align:left; color:var(--muted); padding:6px; border-bottom:1px solid var(--border); }
    .tbl td { padding:6px; border-bottom:1px solid rgba(255,255,255,0.05); }
    .tag { padding:2px 6px; border-radius:4px; font-size:10px; border:1px solid var(--border); }
    .tag.win { border-color:var(--good); color:var(--good); }
    .tag.lose { border-color:var(--bad); color:var(--bad); }

    .flex-center { display:flex; align-items:center; gap:8px; }
    .text-right { text-align:right; }
    .mini-text { font-size:10px; color:var(--muted); margin-top:4px; }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:99; padding:10px;}
    .modal-box { width:min(600px, 100%); background:#0f1730; border:1px solid var(--border); border-radius:8px; padding:20px; box-shadow:0 20px 50px #000; max-height:90vh; overflow-y:auto;}
    .cfg-section { margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:12px; }
    .cfg-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .cfg-add-row { display:flex; gap:8px; margin-top:8px; }
  </style>
</head>

<body>

<div class="container">
  <header>
    <div>
      <h1>ãƒˆãƒ¬ãƒ¼ãƒ‰æ—¥è¨˜ Ultimate</h1>
      <div class="mini-text" id="ghLabel">GitHub: æœªè¨­å®š</div>
    </div>
    <div class="header-btns">
      <button class="btn-primary" id="btnCopyPrompt">ğŸ“‹ AIæŒ‡ç¤ºæ›¸</button>
      <button class="btn-sec" id="btnConfig">âš™ï¸ é¸æŠè‚¢</button>
      <button class="btn-sec" id="btnGitHub">GitHub</button>
      <button class="btn-sec" id="btnBackup">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <button class="btn-sec" id="btnRestore">å¾©å…ƒ</button>
      <button class="btn-sec" id="btnRelock">ãƒ­ãƒƒã‚¯</button>
      <button class="btn-sec" id="btnLecture">ğŸ“˜ è¬›ç¾©ãƒãƒ¼ãƒˆ</button>
    </div>
  </header>

  <section class="card">
    <div class="card-hd">
      <span>ğŸ“ ä»Šæ—¥ã®è¨˜éŒ² (<span id="todayLabel">-</span>)</span>
      <div class="flex-center">
        <button class="btn-sec" id="btnLoadToday" style="padding:2px 8px; font-size:10px;">èª­è¾¼</button>
        <button class="btn-sec" id="btnResetForm" style="padding:2px 8px; font-size:10px;">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div class="card-bd form-grid">
      <div>
        <label>æ—¥ä»˜</label>
        <input type="date" id="date" />
      </div>
      <div>
        <label>ç›¸å ´ç’°å¢ƒ</label>
        <select id="marketType">
          <option value="ä¸æ˜">ä¸æ˜</option>
          <option value="ãƒˆãƒ¬ãƒ³ãƒ‰">ãƒˆãƒ¬ãƒ³ãƒ‰</option>
          <option value="ãƒ¬ãƒ³ã‚¸">ãƒ¬ãƒ³ã‚¸</option>
          <option value="è’ã„">è’ã„</option>
          <option value="è–„ã„">è–„ã„</option>
        </select>
      </div>
      <div>
        <label>çµæœ</label>
        <select id="result">
          <option value="æœªå…¥åŠ›">æœªå…¥åŠ›</option>
          <option value="å‹ã¡">å‹ã¡</option>
          <option value="è² ã‘">è² ã‘</option>
          <option value="ãƒˆãƒ³ãƒˆãƒ³">ãƒˆãƒ³ãƒˆãƒ³</option>
          <option value="ãƒãƒ¼ãƒˆãƒ¬">ãƒãƒ¼ãƒˆãƒ¬</option>
        </select>
      </div>
      <div>
        <label>æç›Š (å††)</label>
        <input type="number" id="pnl" placeholder="ä¾‹: -13070" />
      </div>

      <div>
        <label>ã‚¨ãƒ³ãƒˆãƒªãƒ¼å›æ•°</label>
        <input type="number" id="trades" placeholder="å›æ•° (ä¾‹: 5)" />
      </div>
      <div>
        <label>æ–¹å‘æ„Ÿ</label>
        <select id="bias">
          <option value="ä¸æ˜">ä¸æ˜</option>
          <option value="ãƒ­ãƒ³ã‚°">ãƒ­ãƒ³ã‚°</option>
          <option value="ã‚·ãƒ§ãƒ¼ãƒˆ">ã‚·ãƒ§ãƒ¼ãƒˆ</option>
          <option value="ä¸¡æ–¹ãƒ€ãƒ¡">ä¸¡æ–¹ãƒ€ãƒ¡</option>
        </select>
      </div>
      <div>
        <label>è² ã‘ä¸»å› </label>
        <select id="lossCause"></select>
      </div>
      <div>
        <label>å®ˆã‚ŒãŸãƒ«ãƒ¼ãƒ«</label>
        <select id="keptRule"></select>
      </div>

      <div>
        <label>è‡ªå·±è©•ä¾¡</label>
        <select id="grade">
          <option value="æœªå…¥åŠ›">æœªå…¥åŠ›</option>
          <option value="S">S (å®Œç’§)</option>
          <option value="A">A (è‰¯ã„)</option>
          <option value="B">B (æ™®é€š)</option>
          <option value="C">C (æ‚ªã„)</option>
        </select>
      </div>
      <div>
        <label>æ˜æ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
        <select id="nextAction"></select>
      </div>

      <div class="col-half">
        <label>ä¸»æˆ¦éŠ˜æŸ„</label>
        <div class="chip-group" id="coreTickers"></div>
        <input type="text" id="extraTickers" placeholder="ãã®ä»– (ä¾‹: 9101 å•†èˆ¹ä¸‰äº•)" style="margin-top:6px;" />
      </div>

      <div class="col-full">
        <label>ä¸€è¨€ãƒ¡ãƒ¢ (æ—¥è¨˜)</label>
        <textarea id="memo" placeholder="ã“ã“ã«åçœã‚„æ„Ÿæƒ…ã‚’è©³ã—ãæ›¸ã..."></textarea>
      </div>

      <div class="col-full" style="display:flex; gap:10px; margin-top:4px;">
        <button class="btn-primary" id="btnSave" style="flex:1;">ä¿å­˜ (ãƒ­ãƒ¼ã‚«ãƒ«)</button>
        <button class="btn-sec" id="btnExportCsv">CSV</button>
        <button class="btn-danger" id="btnClearAll">å…¨å‰Šé™¤</button>
      </div>
      <div class="col-full mini-text" id="autoHint">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: OFF</div>
    </div>
  </section>

  <section class="card">
    <div class="card-hd">
      <span>ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (<span id="countLabel">0</span>ä»¶)</span>
    </div>
    <div class="card-bd">
      <div class="kpi-row">
        <div class="kpi-box">
          <div class="kpi-label">ä»Šæœˆæç›Š</div>
          <div class="kpi-val" id="kpiMonthPnl">0</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">å‹ç‡</div>
          <div class="kpi-val" id="kpiWinRate">-</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">ãƒãƒ¼ãƒˆãƒ¬ç‡</div>
          <div class="kpi-val" id="kpiNoTrade">-</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">æœ€å¤šæ•—å› </div>
          <div class="kpi-val" id="kpiTopCause" style="font-size:12px;">-</div>
        </div>
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <span style="font-size:12px; color:var(--muted); font-weight:bold;">éå»ã®è¨˜éŒ²</span>
        <div class="toggle-group">
          <div class="toggle-btn active" id="viewCard">ğŸ“° ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
          <div class="toggle-btn" id="viewTable">ğŸ“‘ ãƒªã‚¹ãƒˆ</div>
        </div>
      </div>

      <div id="viewContainerCard" class="timeline"></div>

      <div id="viewContainerTable" class="tbl-wrap" style="display:none;">
        <table class="tbl">
          <thead>
            <tr>
              <th style="width:80px;">æ—¥ä»˜</th>
              <th style="width:50px;">çµæœ</th>
              <th style="width:70px; text-align:right;">æç›Š</th>
              <th style="padding-left:12px;">è¦ç´„</th>
              <th style="width:60px; text-align:right;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- ğŸ”’ ãƒ­ãƒƒã‚¯ -->
<div class="overlay" id="lockBg" style="display:flex;">
  <div class="modal-box" style="text-align:center;">
    <h3>ğŸ”’ ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯</h3>
    <input type="password" id="lockPass" placeholder="ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin:16px 0; text-align:center; font-size:16px;" />
    <button class="btn-primary" id="btnUnlock" style="width:100%;">è§£é™¤</button>
    <div class="mini-text" style="color:var(--bad); display:none; margin-top:8px;" id="lockErr">ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>
  </div>
</div>

<!-- âš™ï¸ é¸æŠè‚¢ -->
<div class="overlay" id="configBg">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
      <h3 style="margin:0;">é¸æŠè‚¢ã®ç·¨é›†</h3>
      <button class="btn-sec" id="btnCloseConfig" style="padding:2px 8px;">é–‰ã˜ã‚‹</button>
    </div>
    <div id="cfgContainer"></div>
    <div class="mini-text">â€» å¤‰æ›´ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
  </div>
</div>

<!-- GitHubè¨­å®š -->
<div class="overlay" id="modalBg">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
      <h3 style="margin:0;">GitHubè¨­å®š</h3>
      <button class="btn-sec" id="btnCloseModal" style="padding:2px 8px;">é–‰ã˜ã‚‹</button>
    </div>
    <div class="mini-text" id="ghStatus" style="margin-bottom:12px;">çŠ¶æ…‹: æœªè¨­å®š</div>
    <div class="form-grid">
      <div><label>Owner</label><input id="ghOwner" placeholder="user" /></div>
      <div><label>Repo</label><input id="ghRepo" placeholder="repo" /></div>
      <div><label>Branch</label><input id="ghBranch" placeholder="main" /></div>
      <div><label>Path</label><input id="ghPath" placeholder="data/diary.json" /></div>
      <div class="col-full"><label>Token (PAT)</label><input id="ghToken" type="password" /></div>
      <div class="col-full">
        <label>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</label>
        <select id="autoMode">
          <option value="off">OFF</option>
          <option value="onsave">ä¿å­˜æ™‚ã«å®Ÿè¡Œ (æ¨å¥¨)</option>
          <option value="interval">å®šæœŸå®Ÿè¡Œ (15åˆ†)</option>
        </select>
        <input type="hidden" id="autoMinutes" value="15">
      </div>
      <div class="col-full" style="display:flex; gap:10px; margin-top:8px;">
        <button class="btn-primary" id="btnSaveGh" style="flex:1;">ä¿å­˜</button>
        <button class="btn-sec" id="btnTest">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-danger" id="btnClearGh">è§£é™¤</button>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ“˜ è¬›ç¾©ãƒãƒ¼ãƒˆï¼ˆå£Šã‚Œãªã„ï¼šDOMã‚’å…ˆã«ç½®ãï¼‰ -->
<div class="overlay" id="lectureBg">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3 style="margin:0;">ğŸ“˜ ãƒˆãƒ¬ãƒ¼ãƒ‰è¬›ç¾©ãƒãƒ¼ãƒˆ</h3>
      <button class="btn-sec" id="btnCloseLecture" style="padding:2px 8px;">é–‰ã˜ã‚‹</button>
    </div>

    <div style="font-size:13px; line-height:1.7; color:var(--text);">
      <p><strong>â–  ã“ã®ãƒãƒ¼ãƒˆã¯ä½•ã‹</strong></p>
      <ul>
        <li>å…ˆç”Ÿã¨ã®ä¼šè©±ã§å­¦ã‚“ã ã“ã¨ã‚’è“„ç©ã™ã‚‹</li>
        <li>ã‚¶ãƒ©å ´ä¸­ã§ã‚‚ã™ãç¢ºèªã§ãã‚‹</li>
        <li>è‡ªåˆ†å°‚ç”¨ã®ã€Œå‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³è¾æ›¸ã€</li>
      </ul>

      <hr style="border:0; border-top:1px solid var(--border); margin:16px 0;">

      <p style="color:var(--muted);">
        â€» ã“ã®å†…å®¹ã¯å¾Œã§è‡ªç”±ã«ç·¨é›†ãƒ»è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
      </p>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // =========================
  // MASTER DATA & CONFIG
  // =========================
  const OPT_KEY = "tradeDiary_options";
  const DEFAULTS = {
    lossCause: ["ãªã—", "é€†å¼µã‚Šç™–", "åœ°åˆã„æ‚ª", "ãƒ–ãƒ¬ã‚¤ã‚¯ãƒ€ãƒã‚·", "åˆ©ç¢ºãŒæ—©ã„", "æåˆ‡ã‚ŠãŒé…ã„", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãŒæ—©ã„", "ãƒ­ãƒƒãƒˆãŒé‡ã„", "é›†ä¸­ã§ããªã„"],
    keptRule: ["æåˆ‡ã‚Šã‚’å¾¹åº•", "ãƒ­ãƒƒãƒˆæŠ‘åˆ¶", "è¿·ã£ãŸã‚‰è¦‹é€ã‚Š", "1éŠ˜æŸ„é›†ä¸­", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼å¾…ã¦ãŸ", "å¾Œå ´ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã—ãªã„"],
    nextAction: ["åœ°åˆã„ã‚’è¦‹ã¦ç›®ç·šã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹", "å¯„ã‚Š15åˆ†ã¯è§¦ã‚‰ãªã„", "VWAPä»˜è¿‘ã¯è¦‹é€ã‚Š", "ãƒ–ãƒ¬ã‚¤ã‚¯ã¯2æœ¬ç¢ºå®šå¾Œ", "1æ—¥1éŠ˜æŸ„ã«çµã‚‹", "ãƒãƒ¼ãƒˆãƒ¬ã‚‚æ­£è§£ã¨ã™ã‚‹"],
    // â€»ã“ã“ã¯ã€Œå…ƒã«æˆ»ã™ã€ç›®çš„ã§ã€ã¾ãšã¯éå»ã®å½¢ã‚’ç¶­æŒï¼ˆå¾Œã§ç·¨é›†å¯èƒ½ï¼‰
    coreTickers: ["8031 ä¸‰äº•ç‰©ç”£", "9503 é–¢è¥¿é›»åŠ›", "5020 ENEOS", "3099 ä¸‰è¶Šä¼Šå‹¢ä¸¹", "7011 ä¸‰è±é‡å·¥", "6501 æ—¥ç«‹", "9501 æ±äº¬é›»åŠ›", "5406 ç¥æˆ¸è£½é‹¼"]
  };
  let userOpts = JSON.parse(localStorage.getItem(OPT_KEY)||"null") || JSON.parse(JSON.stringify(DEFAULTS));

  function $(id){return document.getElementById(id);}

  function saveUserOpts(){
    localStorage.setItem(OPT_KEY, JSON.stringify(userOpts));
    renderSelects();
  }

  function renderSelects(){
    const fill = (id, list) => {
      const el = $(id);
      if(!el) return;
      el.innerHTML = '<option value="æœªå…¥åŠ›">æœªå…¥åŠ›</option>';
      list.forEach(v => {
        const op=document.createElement("option");
        op.value=v; op.textContent=v;
        el.appendChild(op);
      });
    };
    fill("lossCause", userOpts.lossCause);
    fill("keptRule", userOpts.keptRule);
    fill("nextAction", userOpts.nextAction);

    const tc = $("coreTickers");
    tc.innerHTML = "";
    userOpts.coreTickers.forEach(t => {
      const lbl = document.createElement("label");
      lbl.className = "chip";
      lbl.innerHTML = `<input type="checkbox" value="${t}">${(t.split(" ")[1]||t)}`;
      tc.appendChild(lbl);
    });
  }

  // Generate Prompt
  $("btnCopyPrompt").onclick = () => {
    const opts = userOpts;
    const txt = `
ã‚ãªãŸã¯ç§ã®å°‚å±ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚³ãƒ¼ãƒã€å…ˆç”Ÿã€ã§ã™ã€‚
æœ¬æ—¥ã®ç§ãŸã¡ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ä¼šè©±å±¥æ­´ã¨ã€ä»¥ä¸‹ã®ã€ãƒˆãƒ¬ãƒ¼ãƒ‰æ—¥è¨˜ã€ã®ä»•æ§˜ã«åŸºã¥ãã€ä»Šæ—¥ã®æ—¥è¨˜å…¥åŠ›ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€å‡ºåŠ›è¦ä»¶ã€‘
- å„é …ç›®ã«å¯¾ã—ã€ä¼šè©±å†…å®¹ã‹ã‚‰æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
- è©²å½“ã™ã‚‹ã‚‚ã®ãŒãªã„å ´åˆã¯æ–°ãŸãªé¸æŠè‚¢ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
- ã€Œä¸€è¨€ãƒ¡ãƒ¢ã€ã¯ã€ä¼šè©±ã®æµã‚Œã‹ã‚‰ç§ã®æ„Ÿæƒ…ã‚„åçœç‚¹ã€å…ˆç”Ÿã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¦ç´„ã—ã¦ã€ç°¡æ½”ã‹ã¤å…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
- å‡ºåŠ›ã¯ã‚³ãƒ”ãƒšã—ã‚„ã™ã„å½¢å¼ï¼ˆMarkdownã®ãƒªã‚¹ãƒˆã‚„ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã¾ãŸã¯é …ç›®: å€¤ ã®å½¢å¼ï¼‰ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã€ç¾åœ¨ã®æ—¥è¨˜é …ç›®ã®ä»•æ§˜ã€‘
â–  åŸºæœ¬æƒ…å ±
- æ—¥ä»˜: YYYY/MM/DD
- ç›¸å ´ã‚¿ã‚¤ãƒ—: ä¸æ˜ / ãƒˆãƒ¬ãƒ³ãƒ‰ / ãƒ¬ãƒ³ã‚¸ / è’ã„ / è–„ã„
- çµæœ: å‹ã¡ / è² ã‘ / ãƒˆãƒ³ãƒˆãƒ³ / ãƒãƒ¼ãƒˆãƒ¬
- æç›Š: æ•°å€¤ (å††)
- ã‚¨ãƒ³ãƒˆãƒªãƒ¼å›æ•°: æ•°å€¤ (å›)
- æ–¹å‘æ„Ÿ: ä¸æ˜ / ãƒ­ãƒ³ã‚° / ã‚·ãƒ§ãƒ¼ãƒˆ / ä¸¡æ–¹ãƒ€ãƒ¡ / æœªå…¥åŠ›

â–  é¸æŠè‚¢ãƒªã‚¹ãƒˆï¼ˆâ€»ã“ã“ã‹ã‚‰æœ€ã‚‚è¿‘ã„ã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„ï¼‰
- è² ã‘ä¸»å› : [${opts.lossCause.join(", ")}]
- å®ˆã‚ŒãŸãƒ«ãƒ¼ãƒ«: [${opts.keptRule.join(", ")}]
- æ˜æ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: [${opts.nextAction.join(", ")}]
- ä¸»æˆ¦éŠ˜æŸ„: [${opts.coreTickers.join(", ")}] â€»ã“ã‚Œä»¥å¤–ã®å ´åˆã¯ã‚³ãƒ¼ãƒ‰+åç§°ã§è¨˜è¿°

â–  è©•ä¾¡
- è‡ªå·±è©•ä¾¡: S (å®Œç’§) / A (è‰¯ã„) / B (æ™®é€š) / C (æ‚ªã„)
`.trim();
    navigator.clipboard.writeText(txt).then(()=>alert("AIæŒ‡ç¤ºæ›¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nãƒãƒ£ãƒƒãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"));
  };

  // Config UI
  const cfgBg=$("configBg"), cfgCont=$("cfgContainer");
  function renderConfigUI(){
    cfgCont.innerHTML = "";
    [{k:"lossCause",t:"è² ã‘ä¸»å› "},{k:"keptRule",t:"å®ˆã‚ŒãŸãƒ«ãƒ¼ãƒ«"},{k:"nextAction",t:"æ˜æ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"},{k:"coreTickers",t:"ä¸»æˆ¦éŠ˜æŸ„"}]
      .forEach(sec => {
        const div=document.createElement("div"); div.className="cfg-section";
        const tit=document.createElement("div"); tit.style.fontWeight="bold"; tit.style.marginBottom="6px"; tit.textContent=sec.t; div.appendChild(tit);

        const row=document.createElement("div"); row.className="cfg-add-row";
        const inp=document.createElement("input"); inp.placeholder="è¿½åŠ ...";
        const btn=document.createElement("button"); btn.className="btn-primary"; btn.textContent="è¿½åŠ ";
        btn.onclick=()=>{
          const v=inp.value.trim();
          if(v && !userOpts[sec.k].includes(v)){
            userOpts[sec.k].push(v);
            saveUserOpts();
            renderConfigUI();
          }
        };
        row.appendChild(inp); row.appendChild(btn); div.appendChild(row);

        const list=document.createElement("div"); list.className="cfg-list";
        userOpts[sec.k].forEach(item => {
          const chip=document.createElement("span"); chip.className="chip";
          chip.innerHTML=`${item} <span class="chip-del" data-k="${sec.k}" data-v="${item}">Ã—</span>`;
          list.appendChild(chip);
        });
        div.appendChild(list); cfgCont.appendChild(div);
      });

    // delete handlers
    cfgCont.querySelectorAll(".chip-del").forEach(el=>{
      el.addEventListener("click", ()=>{
        const k = el.getAttribute("data-k");
        const v = el.getAttribute("data-v");
        if(confirm(`ã€Œ${v}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){
          userOpts[k]=userOpts[k].filter(x=>x!==v);
          saveUserOpts();
          renderConfigUI();
        }
      });
    });
  }
  $("btnConfig").onclick=()=>{ renderConfigUI(); cfgBg.style.display="flex"; };
  $("btnCloseConfig").onclick=()=>{ cfgBg.style.display="none"; };

  // =========================
  // CORE LOGIC
  // =========================
  const PASSCODE = "kyoto.3594"; const UNLOCK_KEY = "tradeDiary_unlocked_v1";
  const KEY = "tradeDiary_v1"; const GHKEY = "tradeDiary_github";

  const lockBg=$("lockBg"), lockPass=$("lockPass");
  function isUnlocked(){ return localStorage.getItem(UNLOCK_KEY)==="1"; }
  function showLock(){ lockBg.style.display="flex"; lockPass.value=""; setTimeout(()=>lockPass.focus(),50); }
  function unlock(){
    if(lockPass.value.trim()===PASSCODE){
      localStorage.setItem(UNLOCK_KEY,"1");
      lockBg.style.display="none";
    } else {
      $("lockErr").style.display="block";
    }
  }
  $("btnUnlock").onclick=unlock;
  $("btnRelock").onclick=()=>{ localStorage.removeItem(UNLOCK_KEY); showLock(); };
  lockPass.onkeydown=(e)=>{if(e.key==="Enter")unlock();};
  if(!isUnlocked()) showLock(); else lockBg.style.display="none";

  const els={
    date:$("date"), marketType:$("marketType"), result:$("result"), pnl:$("pnl"),
    trades:$("trades"), bias:$("bias"), lossCause:$("lossCause"), keptRule:$("keptRule"),
    grade:$("grade"), nextAction:$("nextAction"), memo:$("memo"), extraTickers:$("extraTickers")
  };
  const ui={ todayLabel:$("todayLabel"), countLabel:$("countLabel"), rows:$("rows"), cardView:$("viewContainerCard") };
  const todayISO=()=>{ const d=new Date(); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); };

  function loadAll(){ try{return JSON.parse(localStorage.getItem(KEY)||"[]");}catch{return[];} }
  function saveAll(d){ localStorage.setItem(KEY,JSON.stringify(d)); }

  function fmtYen(n){ if(!Number.isFinite(n))return"-"; return (n>0?"+":"")+n.toLocaleString(); }

  const getCore=()=>Array.from(document.querySelectorAll("#coreTickers input:checked")).map(e=>e.value);
  const setCore=(vals)=>{
    const s=new Set(vals||[]);
    document.querySelectorAll("#coreTickers input").forEach(e=>e.checked=s.has(e.value));
  };

  function formToEntry(){
    return {
      date:els.date.value||todayISO(),
      marketType:els.marketType.value,
      result:els.result.value,
      pnl:els.pnl.value===""?null:Number(els.pnl.value),
      tickers:[...getCore(), ...(els.extraTickers.value||"").split(",").map(s=>s.trim()).filter(Boolean)],
      trades:els.trades.value,
      bias:els.bias.value,
      lossCause:els.lossCause.value,
      keptRule:els.keptRule.value,
      grade:els.grade.value,
      nextAction:els.nextAction.value,
      memo:(els.memo.value||"").trim(),
      updatedAt:new Date().toISOString()
    };
  }
  function entryToForm(e){
    els.date.value=e.date||todayISO();
    els.marketType.value=e.marketType||"ä¸æ˜";
    els.result.value=e.result||"æœªå…¥åŠ›";
    els.pnl.value=Number.isFinite(e.pnl)?e.pnl:"";

    const ts=e.tickers||[];
    setCore(ts);
    els.extraTickers.value=ts.filter(t=>!userOpts.coreTickers.includes(t)).join(",");

    els.trades.value=e.trades||"";
    els.bias.value=e.bias||"ä¸æ˜";
    els.lossCause.value=e.lossCause||"æœªå…¥åŠ›";
    els.keptRule.value=e.keptRule||"æœªå…¥åŠ›";
    els.grade.value=e.grade||"æœªå…¥åŠ›";
    els.nextAction.value=e.nextAction||"æœªå…¥åŠ›";
    els.memo.value=e.memo||"";
  }

  let viewMode = "card";
  $("viewCard").onclick = () => {
    viewMode="card"; render();
    $("viewCard").className="toggle-btn active";
    $("viewTable").className="toggle-btn";
    $("viewContainerCard").style.display="flex";
    $("viewContainerTable").style.display="none";
  };
  $("viewTable").onclick = () => {
    viewMode="table"; render();
    $("viewTable").className="toggle-btn active";
    $("viewCard").className="toggle-btn";
    $("viewContainerCard").style.display="none";
    $("viewContainerTable").style.display="block";
  };

  function render(){
    const all=loadAll();
    ui.countLabel.textContent=all.length;
    ui.todayLabel.textContent=els.date.value||todayISO();

    const ym=new Date().toISOString().slice(0,7);
    const m=all.filter(x=>(x.date||"").startsWith(ym));
    const pnl=m.reduce((a,x)=>a+(x.pnl||0),0);
    $("kpiMonthPnl").textContent=fmtYen(pnl);
    $("kpiMonthPnl").className="kpi-val "+(pnl>0?"v-good":(pnl<0?"v-bad":""));

    const w=m.filter(x=>x.result==="å‹ã¡").length, l=m.filter(x=>x.result==="è² ã‘").length;
    $("kpiWinRate").textContent=(w+l)>0?Math.round(w/(w+l)*100)+"%":"-";

    const nt=m.filter(x=>x.result==="ãƒãƒ¼ãƒˆãƒ¬").length;
    $("kpiNoTrade").textContent=m.length>0?Math.round(nt/m.length*100)+"%":"-";

    const counts={};
    m.forEach(x=>{ if(x.lossCause&&x.lossCause!=="æœªå…¥åŠ›") counts[x.lossCause]=(counts[x.lossCause]||0)+1; });
    let top="-", max=0;
    for(let k in counts) if(counts[k]>max){max=counts[k];top=k;}
    $("kpiTopCause").textContent=top;

    const sorted = all.slice().reverse();

    if(viewMode === "table"){
      ui.rows.innerHTML="";
      sorted.forEach(e=>{
        const tr=document.createElement("tr");
        const tag=e.result==="å‹ã¡"?"win":(e.result==="è² ã‘"?"lose":"");
        const pnlC=e.pnl>0?"v-good":(e.pnl<0?"v-bad":"");
        tr.innerHTML=`<td>${e.date}</td>
          <td><span class="tag ${tag}">${e.result}</span></td>
          <td class="text-right ${pnlC}">${fmtYen(e.pnl)}</td>
          <td style="padding-left:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; max-width:200px;">${e.lossCause} | ${e.memo}</td>
          <td class="text-right"><button class="btn-sec" style="padding:2px 6px;" onclick="loadEntry('${e.date}')">âœ</button></td>`;
        ui.rows.appendChild(tr);
      });
    } else {
      ui.cardView.innerHTML = "";
      sorted.forEach(e=>{
        const div = document.createElement("div"); div.className="t-card";
        const resTag = e.result==="å‹ã¡"?"win":(e.result==="è² ã‘"?"lose":"");
        const pnlC = e.pnl>0?"v-good":(e.pnl<0?"v-bad":"");

        let biasCls = "";
        if((e.bias||"").includes("ãƒ­ãƒ³ã‚°")) biasCls="long";
        else if((e.bias||"").includes("ã‚·ãƒ§ãƒ¼ãƒˆ")) biasCls="short";
        else if((e.bias||"").includes("ä¸¡æ–¹")) biasCls="mix";

        let cntCls = "cnt-ok";
        const tNum = Number(e.trades);
        if(tNum >= 3) cntCls="cnt-warn";
        if(tNum >= 6) cntCls="cnt-bad";

        let rankCls = "";
        if(e.grade==="S") rankCls="rank-s";
        else if(e.grade==="A") rankCls="rank-a";
        else if(e.grade==="B") rankCls="rank-b";
        else if(e.grade==="C") rankCls="rank-c";

        let pills = [];
        if((e.tickers||[]).length) pills.push(`<span class="badge">${e.tickers.map(t=>t.split(" ")[1]||t).join("/")}</span>`);
        if(e.bias!=="ä¸æ˜" && e.bias!=="æœªå…¥åŠ›") pills.push(`<span class="badge ${biasCls}">${e.bias}</span>`);
        if(e.trades) pills.push(`<span class="badge ${cntCls}">${e.trades}å›</span>`);
        if(e.grade!=="æœªå…¥åŠ›") pills.push(`<span class="badge ${rankCls}">è©•ä¾¡:${e.grade}</span>`);

        div.innerHTML = `
          <div class="t-top">
            <div class="t-date-grp">
              <div class="t-date">${e.date} <span class="tag ${resTag}">${e.result}</span></div>
            </div>
            <div class="t-actions">
              <button class="btn-sec" style="font-size:10px; padding:4px 8px;" onclick="loadEntry('${e.date}')">ç·¨é›†</button>
              <button class="btn-danger" style="font-size:10px; padding:4px 8px;" onclick="delEntry('${e.date}')">å‰Šé™¤</button>
            </div>
          </div>
          <div class="t-pnl-row"><span class="t-pnl ${pnlC}">${fmtYen(e.pnl)}</span></div>
          <div class="t-meta">${pills.join("")}</div>
          <div class="t-body">${(e.memo||"").replace(/\n/g, "<br>")}</div>
          <div class="t-foot">
            <div class="t-item"><strong>âš ï¸ æ•—å› </strong>${e.lossCause}</div>
            <div class="t-item"><strong>âœ… å®ˆã£ãŸãƒ«ãƒ¼ãƒ«</strong>${e.keptRule}</div>
            <div class="t-item"><strong>ğŸš€ æ˜æ—¥</strong>${e.nextAction}</div>
          </div>`;
        ui.cardView.appendChild(div);
      });
    }

    updateGhLabel();
  }

  window.loadEntry=(d)=>{
    const f=loadAll().find(x=>x.date===d);
    if(f){ entryToForm(f); window.scrollTo
(0,0);
    }
  };

  window.delEntry=(d)=>{
    if(!confirm(`${d} ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const all=loadAll().filter(x=>x.date!==d);
    saveAll(all);
    render();
  };

  // =========================
  // FORM BUTTONS
  // =========================
  function resetFormToToday(){
    els.date.value=todayISO();
    els.marketType.value="ä¸æ˜";
    els.result.value="æœªå…¥åŠ›";
    els.pnl.value="";
    els.trades.value="";
    els.bias.value="ä¸æ˜";
    els.lossCause.value="æœªå…¥åŠ›";
    els.keptRule.value="æœªå…¥åŠ›";
    els.grade.value="æœªå…¥åŠ›";
    els.nextAction.value="æœªå…¥åŠ›";
    els.memo.value="";
    els.extraTickers.value="";
    setCore([]);
    ui.todayLabel.textContent=els.date.value;
  }

  $("btnResetForm").onclick = ()=>{ resetFormToToday(); };
  $("btnLoadToday").onclick = ()=>{
    const d = els.date.value || todayISO();
    const f = loadAll().find(x=>x.date===d);
    if(f){ entryToForm(f); alert(`èª­è¾¼ã—ã¾ã—ãŸ: ${d}`); }
    else { alert(`ã“ã®æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${d}`); }
  };

  $("btnSave").onclick=()=>{
    const e=formToEntry();
    if(!e.date){ alert("æ—¥ä»˜ãŒç©ºã§ã™"); return; }

    const all=loadAll();
    const idx=all.findIndex(x=>x.date===e.date);

    if(idx>=0){
      // updatedAtæ¯”è¼ƒã§ã€è¤‡æ•°ç«¯æœ«ã®è¡çªã‚’ãªã‚‹ã¹ãé¿ã‘ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãªã®ã§è»½ã‚ï¼‰
      const old=all[idx];
      const oldAt = old.updatedAt ? Date.parse(old.updatedAt) : 0;
      const newAt = e.updatedAt ? Date.parse(e.updatedAt) : Date.now();
      if(newAt >= oldAt){
        all[idx]=e;
      }else{
        // å¿µã®ãŸã‚
        all[idx]=e;
      }
    }else{
      all.push(e);
    }
    // æ—¥ä»˜æ˜‡é †ã«ä¸¦ã¹ã‚‹ï¼ˆè¡¨ç¤ºã¯reverseã§æ–°ã—ã„é †ï¼‰
    all.sort((a,b)=>(a.date||"").localeCompare(b.date||""));

    saveAll(all);
    render();
    alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰");

    // auto backup
    const gh = loadGh();
    if(gh.autoMode === "onsave"){
      backupToGitHub().catch(()=>{});
    }
  };

  $("btnClearAll").onclick=()=>{
    if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(KEY);
    render();
    alert("å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã—ã¾ã—ãŸ");
  };

  $("btnExportCsv").onclick=()=>{
    const all=loadAll();
    if(!all.length){ alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    const header=[
      "date","marketType","result","pnl","trades","bias","lossCause","keptRule","grade","nextAction","tickers","memo","updatedAt"
    ];
    const rows=[header.join(",")].concat(all.map(e=>{
      const esc=(v)=>{
        const s = (v===null||v===undefined) ? "" : String(v);
        const t = s.replace(/"/g,'""');
        return `"${t}"`;
      };
      return [
        e.date,e.marketType,e.result,e.pnl,e.trades,e.bias,e.lossCause,e.keptRule,e.grade,e.nextAction,
        (e.tickers||[]).join("/"), (e.memo||""), (e.updatedAt||"")
      ].map(esc).join(",");
    }));
    const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`trade-diary_${todayISO()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  // =========================
  // LECTURE MODAL (open/close)
  // =========================
  const lectureBg=$("lectureBg");
  $("btnLecture").onclick=()=>{ lectureBg.style.display="flex"; };
  $("btnCloseLecture").onclick=()=>{ lectureBg.style.display="none"; };

  // =========================
  // GITHUB STORAGE
  // =========================
  const modalBg=$("modalBg");
  const ghLabel=$("ghLabel");

  function loadGh(){
    try{
      return JSON.parse(localStorage.getItem(GHKEY)||"{}");
    }catch{
      return {};
    }
  }
  function saveGh(obj){
    localStorage.setItem(GHKEY, JSON.stringify(obj||{}));
    updateGhLabel();
  }

  function updateGhLabel(){
    const gh=loadGh();
    if(gh.owner && gh.repo){
      ghLabel.textContent=`GitHub: ${gh.owner}/${gh.repo}@${gh.branch||"main"} (${gh.path||"data/diary.json"})`;
      $("ghStatus").textContent=`çŠ¶æ…‹: è¨­å®šæ¸ˆã¿`;
      $("ghStatus").style.color="var(--good)";
    }else{
      ghLabel.textContent="GitHub: æœªè¨­å®š";
      $("ghStatus").textContent="çŠ¶æ…‹: æœªè¨­å®š";
      $("ghStatus").style.color="var(--muted)";
    }
    $("autoHint").textContent = `è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${ (gh.autoMode||"off").toUpperCase() }`;
  }

  // open github modal
  $("btnGitHub").onclick=()=>{
    const gh=loadGh();
    $("ghOwner").value=gh.owner||"";
    $("ghRepo").value=gh.repo||"";
    $("ghBranch").value=gh.branch||"main";
    $("ghPath").value=gh.path||"data/diary.json";
    $("ghToken").value=gh.token||"";
    $("autoMode").value=gh.autoMode||"off";
    $("ghStatus").textContent = (gh.owner&&gh.repo) ? "çŠ¶æ…‹: è¨­å®šæ¸ˆã¿" : "çŠ¶æ…‹: æœªè¨­å®š";
    modalBg.style.display="flex";
  };
  $("btnCloseModal").onclick=()=>{ modalBg.style.display="none"; };

  $("btnSaveGh").onclick=()=>{
    const gh={
      owner:$("ghOwner").value.trim(),
      repo:$("ghRepo").value.trim(),
      branch:$("ghBranch").value.trim()||"main",
      path:$("ghPath").value.trim()||"data/diary.json",
      token:$("ghToken").value.trim(),
      autoMode:$("autoMode").value
    };
    if(!gh.owner || !gh.repo || !gh.branch || !gh.path || !gh.token){
      alert("Owner/Repo/Branch/Path/Token ã¯å¿…é ˆã§ã™");
      return;
    }
    saveGh(gh);
    alert("GitHubè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    modalBg.style.display="none";
  };

  $("btnClearGh").onclick=()=>{
    if(!confirm("GitHubè¨­å®šã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(GHKEY);
    updateGhLabel();
    alert("è§£é™¤ã—ã¾ã—ãŸ");
    modalBg.style.display="none";
  };

  // --- GitHub API helpers ---
  async function ghFetch(url, gh, opts={}){
    const headers = Object.assign({
      "Accept":"application/vnd.github+json",
      "Authorization":`Bearer ${gh.token}`,
      "X-GitHub-Api-Version":"2022-11-28"
    }, opts.headers||{});
    const res = await fetch(url, {...opts, headers});
    if(!res.ok){
      const txt = await res.text().catch(()=>"(no body)");
      throw new Error(`GitHub API error ${res.status}: ${txt.slice(0,200)}`);
    }
    return res;
  }

  async function getRemoteFile(gh){
    // GET /repos/{owner}/{repo}/contents/{path}?ref={branch}
    const url = `https://api.github.com/repos/${encodeURIComponent(gh.owner)}/${encodeURIComponent(gh.repo)}/contents/${gh.path}?ref=${encodeURIComponent(gh.branch)}`;
    const res = await ghFetch(url, gh, {method:"GET"});
    return await res.json();
  }

  async function putRemoteFile(gh, contentText, message){
    // PUT /repos/{owner}/{repo}/contents/{path}
    const url = `https://api.github.com/repos/${encodeURIComponent(gh.owner)}/${encodeURIComponent(gh.repo)}/contents/${gh.path}`;
    let sha = null;

    // try to read existing sha (file may not exist yet)
    try{
      const remote = await getRemoteFile(gh);
      sha = remote && remote.sha ? remote.sha : null;
    }catch(e){
      // file not found is ok; but GitHub returns 404 which would have thrown.
      // We'll just create new file.
      sha = null;
    }

    const body = {
      message: message || `update diary ${todayISO()}`,
      content: btoa(unescape(encodeURIComponent(contentText))),
      branch: gh.branch
    };
    if(sha) body.sha = sha;

    const res = await ghFetch(url, gh, {method:"PUT", body: JSON.stringify(body)});
    return await res.json();
  }

  function withToast(promise, okMsg, ngMsg){
    return promise.then(()=>{
      if(okMsg) alert(okMsg);
    }).catch((e)=>{
      console.error(e);
      alert((ngMsg||"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ") + "\n\n" + String(e.message||e));
      throw e;
    });
  }

  // =========================
  // BACKUP / RESTORE
  // =========================
  async function backupToGitHub(){
    const gh = loadGh();
    if(!gh.owner || !gh.repo || !gh.token){
      alert("GitHubè¨­å®šãŒæœªè¨­å®šã§ã™ï¼ˆGitHubãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ï¼‰");
      return;
    }
    const all = loadAll();
    const payload = JSON.stringify({
      meta:{
        app:"trade-diary-ultimate",
        version:"v2",
        exportedAt:new Date().toISOString(),
        count:all.length
      },
      data: all
    }, null, 2);

    $("btnBackup").textContent="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­...";
    $("btnBackup").disabled=true;

    try{
      await putRemoteFile(gh, payload, `backup diary ${todayISO()}`);
      $("btnBackup").textContent="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—";
      $("btnBackup").disabled=false;
      alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ï¼ˆGitHubï¼‰");
    }catch(e){
      $("btnBackup").textContent="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—";
      $("btnBackup").disabled=false;
      throw e;
    }
  }

  async function restoreFromGitHub(){
    const gh = loadGh();
    if(!gh.owner || !gh.repo || !gh.token){
      alert("GitHubè¨­å®šãŒæœªè¨­å®šã§ã™ï¼ˆGitHubãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ï¼‰");
      return;
    }
    $("btnRestore").textContent="å¾©å…ƒä¸­...";
    $("btnRestore").disabled=true;

    try{
      const remote = await getRemoteFile(gh);
      if(!remote || !remote.content){
        throw new Error("ãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™");
      }
      const text = decodeURIComponent(escape(atob(remote.content.replace(/\n/g,""))));
      const json = JSON.parse(text);

      // æ—§å½¢å¼: é…åˆ—ã ã‘ / æ–°å½¢å¼: {data:[]}
      const arr = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
      if(!Array.isArray(arr)) throw new Error("å¾©å…ƒãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™");

      // merge: dateã‚­ãƒ¼ã§ updatedAt ãŒæ–°ã—ã„æ–¹ã‚’æ¡ç”¨
      const local = loadAll();
      const map = new Map();
      local.forEach(x=>map.set(x.date, x));
      arr.forEach(x=>{
        if(!x || !x.date) return;
        const cur = map.get(x.date);
        if(!cur){ map.set(x.date, x); return; }
        const curAt = cur.updatedAt ? Date.parse(cur.updatedAt) : 0;
        const xAt   = x.updatedAt ? Date.parse(x.updatedAt) : 0;
        if(xAt >= curAt) map.set(x.date, x);
      });
      const merged = Array.from(map.values()).sort((a,b)=>(a.date||"").localeCompare(b.date||""));

      saveAll(merged);
      render();

      $("btnRestore").textContent="å¾©å…ƒ";
      $("btnRestore").disabled=false;
      alert(`å¾©å…ƒå®Œäº†ï¼ˆGitHubï¼‰: ${merged.length}ä»¶`);
    }catch(e){
      $("btnRestore").textContent="å¾©å…ƒ";
      $("btnRestore").disabled=false;
      throw e;
    }
  }

  $("btnBackup").onclick=()=>withToast(backupToGitHub(), null, "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—");
  $("btnRestore").onclick=()=>{
    if(!confirm("GitHubã‹ã‚‰å¾©å…ƒã—ã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã¨ãƒãƒ¼ã‚¸ã—ã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    withToast(restoreFromGitHub(), null, "å¾©å…ƒå¤±æ•—");
  };

  // =========================
  // TEST CONNECTION
  // =========================
  $("btnTest").onclick=()=>{
    const gh={
      owner:$("ghOwner").value.trim(),
      repo:$("ghRepo").value.trim(),
      branch:$("ghBranch").value.trim()||"main",
      path:$("ghPath").value.trim()||"data/diary.json",
      token:$("ghToken").value.trim()
    };
    if(!gh.owner || !gh.repo || !gh.token){
      alert("Owner/Repo/Token ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    withToast(
      (async()=>{
        // simple repo check
        const url = `https://api.github.com/repos/${encodeURIComponent(gh.owner)}/${encodeURIComponent(gh.repo)}`;
        await ghFetch(url, gh, {method:"GET"});
      })(),
      "æ¥ç¶šOK",
      "æ¥ç¶šNG"
    );
  };

  // =========================
  // AUTO BACKUP (interval)
  // =========================
  let autoTimer = null;

  function startAutoIfNeeded(){
    const gh = loadGh();
    const mode = gh.autoMode || "off";

    if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }

    if(mode==="interval"){
      autoTimer = setInterval(()=>{
        backupToGitHub().catch((e)=>{
          // ã“ã“ã§ã€ŒNetwork connection lost...ã€çš„ãªé€£ç™ºã‚’é¿ã‘ã‚‹
          console.warn("auto backup failed", e);
        });
      }, 15*60*1000);
    }
  }

  // =========================
  // INIT
  // =========================
  renderSelects();
  els.date.value = todayISO();
  ui.todayLabel.textContent = els.date.value;
  updateGhLabel();
  startAutoIfNeeded();
  render();

  // autoMode å¤‰æ›´æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ï¼ˆè¨­å®šã‚’ä¿å­˜ã—ã¦ã‹ã‚‰æœ‰åŠ¹åŒ–ï¼‰
  $("autoMode").addEventListener("change", ()=>{
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§å¤‰ãˆã¦ã‚‚ã€ä¿å­˜ãƒœã‚¿ãƒ³æŠ¼ã™ã¾ã§åæ˜ ã—ãªã„è¨­è¨ˆ
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ãŸå¾Œã«ã‚¿ã‚¤ãƒãƒ¼å†è©•ä¾¡
  const _oldSaveGh = $("btnSaveGh").onclick;
  $("btnSaveGh").onclick = ()=>{
    // æ—¢å­˜å‡¦ç†å®Ÿè¡Œ
    const gh={
      owner:$("ghOwner").value.trim(),
      repo:$("ghRepo").value.trim(),
      branch:$("ghBranch").value.trim()||"main",
      path:$("ghPath").value.trim()||"data/diary.json",
      token:$("ghToken").value.trim(),
      autoMode:$("autoMode").value
    };
    if(!gh.owner || !gh.repo || !gh.branch || !gh.path || !gh.token){
      alert("Owner/Repo/Branch/Path/Token ã¯å¿…é ˆã§ã™");
      return;
    }
    saveGh(gh);
    startAutoIfNeeded();
    alert("GitHubè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    modalBg.style.display="none";
  };

});
</script>

</body>
</html>
